name: Build and Release Executables

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build-linux:
    name: Build Linux x86_64 (${{ matrix.os-name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            os-name: "Ubuntu 20.04"
            os-suffix: "ubuntu20"
          - os: ubuntu-22.04
            os-name: "Ubuntu 22.04"
            os-suffix: "ubuntu22"
          - os: ubuntu-24.04
            os-name: "Ubuntu 24.04"
            os-suffix: "ubuntu24"
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true  # å¯ç”¨ Git LFS ä»¥ä¸‹è½½æ¨¡å‹æ–‡ä»¶

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf

      - name: å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: å®‰è£… Python ä¾èµ–
        run: |
          uv sync

      - name: éªŒè¯ Nuitka å®‰è£…
        run: |
          uv run python -m nuitka --version
          echo "âœ… Nuitka å®‰è£…æˆåŠŸ"

      - name: ç¼–è¯‘ Linux å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          chmod +x build.sh
          bash build.sh

      - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          cd dist
          # æŸ¥æ‰¾ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ nsfwpy æˆ– nsfwpy.binï¼‰
          if [ -f nsfwpy.bin ]; then
            EXEC_FILE=nsfwpy.bin
          elif [ -f nsfwpy ]; then
            EXEC_FILE=nsfwpy
          else
            echo "æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            ls -la
            exit 1
          fi
          
          VERSION="${GITHUB_REF_NAME#v}"
          OS_SUFFIX="${{ matrix.os-suffix }}"
          if [ "$GITHUB_REF_TYPE" = "tag" ]; then
            mv "$EXEC_FILE" "nsfwpy-${VERSION}-linux-x86_64-${OS_SUFFIX}"
          else
            mv "$EXEC_FILE" "nsfwpy-latest-linux-x86_64-${OS_SUFFIX}"
          fi
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x nsfwpy-*-linux-x86_64-*

      - name: æ£€æŸ¥ä¾èµ–åº“ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
        run: |
          cd dist
          EXEC_FILE=$(ls nsfwpy-*-linux-x86_64-*)
          echo "=== å¯æ‰§è¡Œæ–‡ä»¶ä¾èµ–çš„åŠ¨æ€åº“ ==="
          ldd "$EXEC_FILE" || true
          echo ""
          echo "=== GLIBC ç‰ˆæœ¬è¦æ±‚ ==="
          objdump -T "$EXEC_FILE" | grep GLIBC | sed 's/.*GLIBC_\([.0-9]*\).*/\1/g' | sort -Vu | tail -1

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          sha256sum nsfwpy-*-linux-x86_64-* > nsfwpy-linux-x86_64-${{ matrix.os-suffix }}.sha256
          cat nsfwpy-linux-x86_64-${{ matrix.os-suffix }}.sha256

      - name: ç”Ÿæˆæ„å»ºæ‘˜è¦
        run: |
          echo "## Linux x86_64 (${{ matrix.os-name }}) æ„å»ºæˆåŠŸ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–‡ä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/nsfwpy-*-linux-x86_64-* >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA256 æ ¡éªŒå’Œ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dist/nsfwpy-linux-x86_64-${{ matrix.os-suffix }}.sha256 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: nsfwpy-linux-x86_64-${{ matrix.os-suffix }}
          path: |
            dist/nsfwpy-*-linux-x86_64-*
            dist/nsfwpy-linux-x86_64-${{ matrix.os-suffix }}.sha256
          retention-days: 7

  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true  # å¯ç”¨ Git LFS ä»¥ä¸‹è½½æ¨¡å‹æ–‡ä»¶

      - name: å®‰è£… uv
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: å®‰è£… Python ä¾èµ–
        run: |
          uv sync

      - name: éªŒè¯ Nuitka å®‰è£…
        run: |
          uv run python -m nuitka --version
          Write-Host "âœ… Nuitka å®‰è£…æˆåŠŸ"

      - name: ç¼–è¯‘ Windows å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          .\build.bat

      - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          cd dist
          if (Test-Path "nsfwpy.exe") {
            $version = "$env:GITHUB_REF_NAME" -replace '^v', ''
            if ($env:GITHUB_REF_TYPE -eq "tag") {
              Rename-Item "nsfwpy.exe" "nsfwpy-$version-win-x86_64.exe"
            } else {
              Rename-Item "nsfwpy.exe" "nsfwpy-latest-win-x86_64.exe"
            }
          }

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          Get-FileHash -Algorithm SHA256 nsfwpy-*-win-x86_64.exe | Format-List | Out-File -FilePath nsfwpy-windows-x86_64.sha256
          Get-Content nsfwpy-windows-x86_64.sha256

      - name: ç”Ÿæˆæ„å»ºæ‘˜è¦
        run: |
          "## Windows x86_64 æ„å»ºæˆåŠŸ âœ…" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "### æ–‡ä»¶ä¿¡æ¯" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          Get-ChildItem dist\nsfwpy-*-win-x86_64.exe | Format-Table Name, Length, LastWriteTime | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "### SHA256 æ ¡éªŒå’Œ" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          Get-Content dist\nsfwpy-windows-x86_64.sha256 | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: nsfwpy-windows-x86_64
          path: |
            dist/nsfwpy-*-win-x86_64.exe
            dist/nsfwpy-windows-x86_64.sha256
          retention-days: 7

  upload-latest:
    name: Upload Latest Build (main branch)
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
        run: |
          echo "=== Latest æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
          find artifacts -type f -exec ls -lh {} \;
          
      - name: ç”Ÿæˆæ„å»ºæ‘˜è¦
        run: |
          echo "## æœ€æ–°æ„å»ºå®Œæˆ (mainåˆ†æ”¯) âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ„å»ºäº§ç‰©å·²ä¿å­˜ä¸º artifactsï¼Œä¿ç•™7å¤©ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find artifacts -type f -name "nsfwpy-*" ! -name "*.sha256" -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  create-release:
    name: Create Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true  # å¯ç”¨ Git LFS ä»¥ä¸‹è½½æ¨¡å‹æ–‡ä»¶

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
        run: |
          echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
          find artifacts -type f -exec ls -lh {} \;
          echo ""
          echo "=== SHA256 æ ¡éªŒå’Œ ==="
          find artifacts -name "*.sha256" -exec cat {} \;

      - name: å‡†å¤‡ Release è¯´æ˜
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          cat > release_notes.md << EOF
          # NSFWpy $VERSION
          
          ## ğŸ“¦ ä¸‹è½½
          
          ### Linux x86_64
          
          æ ¹æ®ä½ çš„ç³»ç»Ÿé€‰æ‹©å¯¹åº”ç‰ˆæœ¬ï¼š
          
          - **Ubuntu 20.04 / Debian 10+** (GLIBC 2.31+)
            - [nsfwpy-${VERSION}-linux-x86_64-ubuntu20](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nsfwpy-${VERSION}-linux-x86_64-ubuntu20)
          
          - **Ubuntu 22.04 / Debian 11+** (GLIBC 2.34+) - æ¨è
            - [nsfwpy-${VERSION}-linux-x86_64-ubuntu22](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nsfwpy-${VERSION}-linux-x86_64-ubuntu22)
          
          - **Ubuntu 24.04+** (æœ€æ–° GLIBC)
            - [nsfwpy-${VERSION}-linux-x86_64-ubuntu24](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nsfwpy-${VERSION}-linux-x86_64-ubuntu24)
          
          > ğŸ’¡ **æç¤º**ï¼šå¦‚æœä¸ç¡®å®šé€‰å“ªä¸ªç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ ubuntu20 ç‰ˆæœ¬ï¼Œå…¼å®¹æ€§æœ€å¥½
          
          ### Windows x86_64
          - [nsfwpy-${VERSION}-win-x86_64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/nsfwpy-${VERSION}-win-x86_64.exe)
          
          ---
          
          ## âœ… æ ¡éªŒå’Œ
          
          ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          
          \`\`\`bash
          # Linux (ä»¥ ubuntu22 ä¸ºä¾‹)
          sha256sum nsfwpy-${VERSION}-linux-x86_64-ubuntu22
          
          # Windows (PowerShell)
          Get-FileHash nsfwpy-${VERSION}-win-x86_64.exe -Algorithm SHA256
          \`\`\`
          
          ## ğŸš€ å®‰è£…
          
          ### Linux
          \`\`\`bash
          # ä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ï¼ˆä»¥ ubuntu22 ä¸ºä¾‹ï¼‰
          chmod +x nsfwpy-${VERSION}-linux-x86_64-ubuntu22
          
          # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
          sudo mv nsfwpy-${VERSION}-linux-x86_64-ubuntu22 /usr/local/bin/nsfwpy
          
          # éªŒè¯å®‰è£…
          nsfwpy --version
          \`\`\`
          
          ### Windows
          1. ä¸‹è½½ \`nsfwpy-${VERSION}-win-x86_64.exe\`
          2. é‡å‘½åä¸º \`nsfwpy.exe\`
          3. æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡
          
          ## ğŸ“– ä½¿ç”¨æ–¹æ³•
          
          \`\`\`bash
          # æ£€æµ‹å›¾ç‰‡
          nsfwpy --input image.jpg
          
          # æ£€æµ‹è§†é¢‘
          nsfwpy --input video.mp4 --sample-rate 0.1 --max-frames 100
          
          # å¯åŠ¨Web APIæœåŠ¡
          nsfwpy --web --host 0.0.0.0 --port 8000
          \`\`\`
          
          ## ğŸ³ Docker
          
          \`\`\`bash
          docker pull yiminger/nsfwpy:${VERSION}
          docker run -p 8000:8000 yiminger/nsfwpy:${VERSION}
          \`\`\`
          
          ## ğŸ“¦ PyPI
          
          \`\`\`bash
          pip install nsfwpy==${VERSION}
          \`\`\`
          
          ---
          
          ## ğŸ”§ ç³»ç»Ÿå…¼å®¹æ€§
          
          ### Linux å‘è¡Œç‰ˆæ”¯æŒ
          | å‘è¡Œç‰ˆ | æœ€ä½ç‰ˆæœ¬ | æ¨èä¸‹è½½ |
          |--------|----------|----------|
          | Ubuntu | 20.04+ | ubuntu20 æˆ– ubuntu22 |
          | Debian | 10+ | ubuntu20 |
          | CentOS/RHEL | 8+ | ubuntu20 |
          | Fedora | 33+ | ubuntu22 |
          | Arch Linux | æœ€æ–° | ubuntu24 |
          
          ### Windows
          - Windows 10/11 (x64)
          - Windows Server 2019/2022
          
          EOF
          cat release_notes.md

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/nsfwpy-linux-x86_64-ubuntu20/*
            artifacts/nsfwpy-linux-x86_64-ubuntu22/*
            artifacts/nsfwpy-linux-x86_64-ubuntu24/*
            artifacts/nsfwpy-windows-x86_64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

